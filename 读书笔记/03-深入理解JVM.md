# JVM虚拟机学习
> 书于：2018-07-04

> 更新：2019-07-11

### 参考
- 周志明大佬的《深入理解Java虚拟机》
- 阿里大佬的公众号——【你假笨】
- [JDK工具使用：定位CPU消耗最高的线程](https://mp.weixin.qq.com/s?__biz=MzIzNjI1ODc2OA==&mid=403257534&idx=1&sn=2015e011c50c0a9107a48aa60a4adb78&scene=21#wechat_redirect)
- GitChat
---

## 垃圾回收

### 回收算法

- 标记清除算法

  将死亡对象进行标记，然后进行清除，但是容易造成内存碎片

- 标记整理算法

  让所有存活的对象都向一端移动，然后直接清理掉该端边界以外的内存。

  解决了内存碎片的问题，但是移动对象的成本过高

- 标记压缩算法

  标记过程与前面相同，压缩过程让对象紧凑的排列在一起

- 复制算法

  将内存分为两等分，只使用一半的内存，当发生垃圾回收时，把存活的对象copy到另外一半中，但是对内存的使用率非常低，只能用一半（空间换时间的思想）

### 垃圾收集器

- 新生代

  - Serial

    单线程

  - Parallel New

    多线程

  - Parallel Scavenge

    多线程，但是注重吞吐量

- G1收集器

  用来替换老年代的CMS收集器，在新生代和老年代中都可以用

- 老年代

  - Serial Old     

    单线程

  - Parallel Old

    多线程

  - CMS               

    并行处理

### 对象可回收算法

- 引用计数算法

  原理：
  为每一个对象分配一个引用计数器，当对象被引用时，计数器加1，如果该对象的计数器为0则表示没有被引用，可以被回收

  优点：
  简单

  缺点：
  容易造成A引用B，B引用A，造成内存泄漏（无法被回收）

- 可达性分析算法

  原理：
  从一系列GC Roots开始搜索，能够被引用到的对象说明是存活，反之。

  优点：
  可以解决引用计数法的缺点

## 运行时数据区

### 方法区

存放类加载信息，常量，静态变量，常量池，字面量和符号引用

该区域线程共享

### 堆

存放对象

堆被分为新生代和老年代

新生代又分为Eden区和两个大小相同的Survivor区

当new一个对象的时候会在Eden区划分一段内存，当Eden区内存不够用的时候会触发一次Minor GC，存活下来的会被送到Survivor区中。如果一个对象在Survivor区被复制多次（默认15）会被送到老年区。当单个Survivor占用50%的时候复制次数较多的对象也会被送到老年区

该区域线程共享

### 虚拟机栈

每一个方法都会创建一个栈帧，用来存放局部变量表，操作数栈，动态链接，方法出口等信息

当抛出异常信息时，抛出来的就是栈信息，因此要少打印异常栈信息，消耗资源

该区域线程私有

### 程序计数器

标记线程执行位置

该区域方法私有

### 本地方法栈

存放的是Native方法，有c，c++编写的方法

## 类加载机制

### 类 的生命周期

- 加载
- 验证
- 准备
- 解析
- 初始化
- 使用
- 卸载

### 类的加载过程

- 加载

  查找相应的class文件，并根据该class文件创建类的过程

- 验证

  确保这个类是合法的符合规范条件的

- 准备

  为类中静态字段分配内存，代码中静态字段的初始化

- 解析

  class文件被Java虚拟机加载之前，这个类不知道它的方法、字段地址，Java编译器会生成一个符号引用定位到具体的目标上。
  解析就是将符号引用解析成实际引用

- 初始化

  是类加载的最后一步，为常量值的字段赋值，只有初始化完成，一个类才正式成为可执行状态

### 类加载器

- 启动类加载器(Bootstrap ClassLoader)
- 扩展类加载器(Extension ClassLoader)
- 应用程序类加载器(Application ClassLoader)

## jdk命令工具

### jstack

生成线程dump文件

### javac

将xxx.java文件编译成xxx.class文件
javac [xxx.java]

### javap

反编译
javap -c [class文件] 反编译
javap -verbose [class文件] 打印具体的信息

### jstat

查看垃圾回收信息
jstat -gc [pid] [间隔ms] [打印次数]
jstat -gcutil [pid]

### jinfo

查看JVM配置参数
jinfo -flags [pid]

### jar

jar包操作
jar xvf [xxx.jar]  解压该jar包

### jps

列出Java进程
jps -l	该进程详细信息
jps -v JVM进程启动时的JVM参数

## 参数调优

### 堆

-Xms JVM堆的最小值

-Xmx JVM堆的最大值

-Xmn JVM新生代的大小

### 虚拟机栈

-Xss   每个线程虚拟机栈的大小

### 参数配置

-XX: + <option> 开启option参数

-XX: — <option> 关闭option参数

-XX: <option> = <value> 将option参数的值设置为value

*XMind: ZEN - Trial Version*